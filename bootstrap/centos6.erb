bash -c '


if [ ! -f /usr/bin/chef-client ]; then
  mkdir /opt/chef
  mkdir /etc/chef
  cd /opt/chef
  curl -L http://www.opscode.com/chef/install.sh | bash
  /usr/sbin/ntpdate 210.72.145.44

  fi

  (
  cat <<'EOP'
  <%= validation_key %>
  EOP
  ) > /tmp/validation.pem
  awk NF /tmp/validation.pem > /etc/chef/validation.pem
  rm /tmp/validation.pem

  <% if @chef_config[:encrypted_data_bag_secret] -%>
    (
    cat <<'EOP'
    <%= encrypted_data_bag_secret %>
    EOP
    ) > /tmp/encrypted_data_bag_secret
    awk NF /tmp/encrypted_data_bag_secret > /etc/chef/encrypted_data_bag_secret
    rm /tmp/encrypted_data_bag_secret
  <% end -%>

  (
  cat <<'EOP'
  <%= config_content %>
  EOP
  ) > /etc/chef/client.rb

  (
  cat <<'EOP'
  <%= { "run_list" => @run_list }.to_json %>
  EOP
  ) > /etc/chef/first-boot.json

  <%= start_chef %>''>)>)))'
